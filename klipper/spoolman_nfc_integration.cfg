# Spoolman NFC Tag Integration for Multi-Tool
# This macro allows automatic spool assignment when NFC tags are scanned
# 
# Hardware Requirements:
# - ESP32 + PN532 NFC reader (OpenSpool reader)
# - Reader should POST to Moonraker API endpoint
#
# Usage:
#   LOAD_SPOOL_FROM_NFC TOOL=0 SPOOL_ID=123
#   Or set up your NFC reader to call this automatically

[gcode_macro LOAD_SPOOL_FROM_NFC]
description: Load a spool to a specific tool from NFC tag data
gcode:
  {% if params.TOOL is not defined %}
    {action_respond_info("Error: TOOL parameter required (e.g., TOOL=0)")}
  {% elif params.SPOOL_ID is not defined %}
    {action_respond_info("Error: SPOOL_ID parameter required")}
  {% else %}
    {% set tool = params.TOOL|int %}
    {% set spool_id = params.SPOOL_ID|int %}
    {% set tool_macro = "T" ~ tool %}
    
    # Validate tool exists
    {% if printer["gcode_macro " ~ tool_macro] is defined %}
      # Assign spool to the tool
      SET_GCODE_VARIABLE MACRO={tool_macro} VARIABLE=spool_id VALUE={spool_id}
      
      # Set as active spool
      SET_ACTIVE_SPOOL ID={spool_id}
      
      # Save to persistent storage
      UPDATE_DELAYED_GCODE ID=SAVE_SELECTED_SPOOLS DURATION=0.01
      
      RESPOND PREFIX="ðŸ§¶ NFC" MSG="Loaded Spool {spool_id} to {tool_macro}"
    {% else %}
      {action_respond_info("Error: Tool " ~ tool_macro ~ " not found")}
    {% endif %}
  {% endif %}

[gcode_macro LOAD_CURRENT_TOOL_FROM_NFC]
description: Load a spool to the currently active tool from NFC tag
gcode:
  {% if params.SPOOL_ID is not defined %}
    {action_respond_info("Error: SPOOL_ID parameter required")}
  {% else %}
    {% set spool_id = params.SPOOL_ID|int %}
    {% set current_tool = printer.toolhead.extruder %}
    
    # Extract tool number from extruder name (e.g., "extruder" = T0, "extruder1" = T1)
    {% if current_tool == "extruder" %}
      {% set tool_num = 0 %}
    {% else %}
      {% set tool_num = current_tool.replace("extruder", "")|int %}
    {% endif %}
    
    LOAD_SPOOL_FROM_NFC TOOL={tool_num} SPOOL_ID={spool_id}
  {% endif %}

# Webhook handler for NFC reader (ESP32)
# Configure your NFC reader to POST to:
# http://your-printer-ip/printer/gcode/script?script=WEBHOOK_NFC_SCANNED%20SPOOL_ID=123%20TOOL=0
[gcode_macro WEBHOOK_NFC_SCANNED]
description: Handler for NFC reader webhook calls
gcode:
  {% if params.SPOOL_ID is defined %}
    {% if params.TOOL is defined %}
      LOAD_SPOOL_FROM_NFC TOOL={params.TOOL} SPOOL_ID={params.SPOOL_ID}
    {% else %}
      # If no tool specified, use current tool
      LOAD_CURRENT_TOOL_FROM_NFC SPOOL_ID={params.SPOOL_ID}
    {% endif %}
  {% else %}
    {action_respond_info("NFC scan received but no SPOOL_ID found")}
  {% endif %}

# Manual NFC spool loading with user prompt
[gcode_macro NFC_SCAN_MODE]
description: Enter NFC scan mode - next scan will load to specified tool
variable_target_tool: -1
variable_enabled: 0
gcode:
  {% if params.TOOL is defined %}
    {% set tool = params.TOOL|int %}
    SET_GCODE_VARIABLE MACRO=NFC_SCAN_MODE VARIABLE=target_tool VALUE={tool}
    SET_GCODE_VARIABLE MACRO=NFC_SCAN_MODE VARIABLE=enabled VALUE=1
    RESPOND PREFIX="ðŸ§¶ NFC" MSG="Scan mode enabled for T{tool}. Scan an NFC tag to load spool."
  {% else %}
    SET_GCODE_VARIABLE MACRO=NFC_SCAN_MODE VARIABLE=enabled VALUE=0
    RESPOND PREFIX="ðŸ§¶ NFC" MSG="Scan mode disabled"
  {% endif %}

# Example OpenSpool ESP32 Configuration
# Add this to your ESP32 firmware or use a Python script:
#
# When NFC tag with OpenSpool JSON is detected:
# 1. Extract spool_id from your Spoolman database (match by brand/color/type)
#    OR store spool_id in a custom field in the OpenSpool JSON
# 2. Send HTTP POST to Moonraker:
#    POST http://printer-ip/printer/gcode/script
#    Body: script=WEBHOOK_NFC_SCANNED SPOOL_ID=123 TOOL=0
#
# Python example for ESP32/Raspberry Pi:
#   import requests
#   requests.post(
#       "http://printer-ip/printer/gcode/script",
#       params={"script": f"WEBHOOK_NFC_SCANNED SPOOL_ID={spool_id} TOOL={tool}"}
#   )
